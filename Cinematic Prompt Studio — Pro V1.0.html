<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinematic Prompt Studio — Pro</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0e1627; --ink:#e5e7eb; --muted:#9ca3af;
      --pri:#60a5fa; --acc:#22d3ee; --ok:#34d399; --warn:#f59e0b; --err:#f87171;
      --radius:16px; --shadow-sm:0 1px 2px rgba(0,0,0,.25); --shadow-md:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#071022,var(--bg));color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;letter-spacing:.2px}
    a{color:var(--acc);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1280px;margin:20px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:50%;background:radial-gradient(circle at 35% 35%,var(--acc),transparent 60%),radial-gradient(circle at 65% 65%,var(--pri),transparent 60%),linear-gradient(135deg,#1f2937,#0b1220);box-shadow:var(--shadow-md)}
    h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:12px}
    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.25);box-shadow:var(--shadow-md)}
    .btn:active{transform:translateY(1px)}
    .btn.pri{background:linear-gradient(180deg,rgba(34,211,238,.25),rgba(34,211,238,.12));border-color:rgba(34,211,238,.5);color:#e0f2fe}
    .btn.ok{background:linear-gradient(180deg,rgba(52,211,153,.25),rgba(52,211,153,.12));border-color:rgba(52,211,153,.5);color:#dcfce7}
    .btn.warn{background:linear-gradient(180deg,rgba(245,158,11,.25),rgba(245,158,11,.12));border-color:rgba(245,158,11,.5);color:#fffbeb}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow-sm)}
    .card h2{font-size:14px;margin:0;padding:14px;border-bottom:1px solid rgba(255,255,255,.06);color:#dbeafe;letter-spacing:.25px}
    .card .body{padding:14px}
    .section{display:grid;gap:10px;margin-bottom:12px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:760px){.row,.row-3{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    input[type="text"],input[type="url"],input[type="number"],textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--ink);outline:none}
    textarea{min-height:68px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:rgba(96,165,250,.55);box-shadow:0 0 0 3px rgba(96,165,250,.12)}
    .kbd{font:600 11px/1.3 ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:6px}
    .meter{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:11px}
    .meter-bar{flex:1;height:8px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .meter-bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--pri),var(--acc))}
    .preview{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f1a;border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);padding:16px;white-space:pre-wrap;min-height:360px;color:#e2e8f0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);color:#bfdbfe;font-size:11px}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    details>summary{padding:8px 10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px}
    .lint{font-size:12px;line-height:1.4}
    .lint b{color:#fde68a}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Cinematic Prompt Studio — Pro</h1>
          <div class="sub">CREATE for video: <span class="pill">C</span>oncept <span class="pill">R</span>ole <span class="pill">E</span>lements <span class="pill">A</span>sk <span class="pill">T</span>one <span class="pill">E</span>valuate — plus engine presets, motion arcs, and linting.</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnNew" class="btn">New</button>
        <button id="btnExport" class="btn" title="Export worksheet JSON">Export</button>
        <label class="btn" for="fileImport" title="Import worksheet JSON">Import<input id="fileImport" type="file" accept="application/json" style="display:none"></label>
        <button id="btnCopy" class="btn pri">Copy Prompt</button>
        <button id="btnDownload" class="btn ok">Download .txt</button>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-labelledby="ws-title">
        <h2 id="ws-title">Worksheet</h2>
        <div class="body">
          <!-- PROFILE / ENGINE PRESET -->
          <div class="section">
            <div class="row">
              <div>
                <label for="profile">Profile name</label>
                <input id="profile" type="text" placeholder="e.g., Mythic Nature v2" />
              </div>
              <div>
                <label for="engine">Engine preset</label>
                <select id="engine">
                  <option value="runway">Runway Gen-3</option>
                  <option value="pika">Pika 2.1</option>
                  <option value="kling">Kling v1</option>
                  <option value="sora">Sora (speculative)</option>
                  <option value="generic" selected>Generic / Text-only</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label for="title">Concept — Title</label>
                <input id="title" type="text" placeholder="e.g., Whispering Silence" />
              </div>
              <div>
                <label for="handle">Concept — Subject Handle (optional)</label>
                <input id="handle" type="text" placeholder="e.g., @artist" />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="environment">Concept — Environment label</label>
                <input id="environment" type="text" placeholder="e.g., Mythic Nature" />
              </div>
              <div>
                <label for="concept">Concept — Narrative logline</label>
                <input id="concept" type="text" placeholder="e.g., Lucid‑zen meditation in a primeval dreamscape." />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="role">Role — Who is the AI?</label>
                <input id="role" type="text" placeholder="e.g., Visionary cinematographer + director crafting composition, motion, and light." />
              </div>
              <div>
                <label for="tone">Tone — Output voice</label>
                <input id="tone" type="text" placeholder="e.g., zen‑fantasy / awe‑forward" />
              </div>
            </div>
          </div>

          <!-- ELEMENTS: SUBJECT / SCENE SETTINGS -->
          <details open>
            <summary><b>Elements — Subject / Scene</b> <span class="sub">(audience, subject, features, setting)</span></summary>
            <div class="section" style="margin-top:10px">
              <div class="row">
                <div>
                  <label for="audience">Audience / Locale</label>
                  <input id="audience" type="text" placeholder='e.g., {locale="JP"}' />
                </div>
                <div>
                  <label for="narrativeTone">Narrative tone</label>
                  <input id="narrativeTone" type="text" placeholder="e.g., lucid‑zen / awe‑forward" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="subjectType">Subject type</label>
                  <input id="subjectType" type="text" placeholder="e.g., person (meditation guru)" />
                </div>
                <div>
                  <label for="environmentType">Environment type</label>
                  <input id="environmentType" type="text" placeholder="e.g., fantastical nature" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="keyFeatures">Key features (semicolon‑separated)</label>
                  <textarea id="keyFeatures" placeholder="e.g., seated lotus; breath vapor; bioluminescent pollen; floating stones"></textarea>
                </div>
                <div>
                  <label for="scaleMotion">Scale & Motion arc</label>
                  <input id="scaleMotion" type="text" placeholder="e.g., Scale: intimate→cosmic; Motion: emergence → expansion → resolution" />
                </div>
              </div>
              <div class="row-3">
                <div>
                  <label for="age">Age</label>
                  <input id="age" type="text" placeholder="e.g., 30s" />
                </div>
                <div>
                  <label for="vibe">Vibe</label>
                  <input id="vibe" type="text" placeholder="e.g., calm, enigmatic" />
                </div>
                <div>
                  <label for="skin">Skin/Makeup/Hair</label>
                  <input id="skin" type="text" placeholder="e.g., Skin: fair; Makeup: natural; Hair: black, neat" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="outfit">Outfit</label>
                  <input id="outfit" type="text" placeholder="e.g., sand‑ivory kimono + dark hakama + barefoot" />
                </div>
                <div>
                  <label for="accessories">Accessories</label>
                  <input id="accessories" type="text" placeholder="e.g., wooden mala beads" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="location">Location</label>
                  <input id="location" type="text" placeholder="e.g., moss cathedral valley" />
                </div>
                <div>
                  <label for="timeOfDay">Time</label>
                  <input id="timeOfDay" type="text" placeholder="e.g., blue hour→astral night" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="weatherLight">Weather / Light</label>
                  <input id="weatherLight" type="text" placeholder="e.g., cool mist, god rays, light rain sparkle" />
                </div>
                <div>
                  <label for="visualTaste">Visual taste</label>
                  <input id="visualTaste" type="text" placeholder="e.g., zen sci‑fantasy / prestige doc" />
                </div>
              </div>
              <div class="row-3">
                <div>
                  <label for="fg">Key elements — Foreground (FG)</label>
                  <textarea id="fg" placeholder="e.g., dew ferns; soft fireflies"></textarea>
                </div>
                <div>
                  <label for="mg">Key elements — Midground (MG)</label>
                  <textarea id="mg" placeholder="e.g., subject on basalt slab"></textarea>
                </div>
                <div>
                  <label for="bg">Key elements — Background (BG)</label>
                  <textarea id="bg" placeholder="e.g., mythic cedars; obsidian torii"></textarea>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="lighting">Lighting</label>
                  <textarea id="lighting" placeholder="e.g., motivated key; soft; rim/kicker; neg fill; bounce; gobo; haze medium; vol shafts"></textarea>
                </div>
                <div>
                  <label for="grade">Grade / Look</label>
                  <textarea id="grade" placeholder="e.g., teal–amber palette; S‑curve contrast; gentle halation; vignette; fine grain; mild CA; clean anamorphic flares"></textarea>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="persist">Persisting motifs</label>
                  <input id="persist" type="text" placeholder="e.g., same jacket; floating pollen; breath condenses in CU" />
                </div>
                <div>
                  <label for="backgroundDesc">Background / Location descriptor</label>
                  <input id="backgroundDesc" type="text" placeholder="e.g., primeval Japan dreamscape" />
                </div>
              </div>
            </div>
          </details>

          <!-- CAMERA / LENS / COVERAGE -->
          <details open>
            <summary><b>Elements — Camera / Lens / Coverage</b></summary>
            <div class="section" style="margin-top:10px">
              <div class="row">
                <div>
                  <label for="camera">Camera (angles / moves)</label>
                  <textarea id="camera" placeholder="WS/MS/CU/ECU/Insert; centered→thirds; occluders/parallax; jib/gimbal/orbit/whip/POV"></textarea>
                </div>
                <div>
                  <label for="lens">Lens / Focus</label>
                  <textarea id="lens" placeholder="24/35/50/90 feel; macro; creamy bokeh; gentle racks; face priority"></textarea>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="coverage">Coverage</label>
                  <textarea id="coverage" placeholder="master + tactile inserts; match‑on‑action; screen direction; eyelines"></textarea>
                </div>
                <div>
                  <label for="duration">Clip duration (s)</label>
                  <input id="duration" type="number" step="0.1" placeholder="e.g., 8.0" />
                </div>
              </div>
            </div>
          </details>

          <!-- MOTION ARC (TIMECODED) -->
          <details open>
            <summary><b>Motion Arc</b> <span class="sub">(timecoded beats)</span></summary>
            <div class="section" style="margin-top:10px">
              <div class="row-3">
                <div>
                  <label for="beat1">Beat 1</label>
                  <input id="beat1" type="text" placeholder="[0–2s] emergence: breath opens; particles wake" />
                </div>
                <div>
                  <label for="beat2">Beat 2</label>
                  <input id="beat2" type="text" placeholder="[2–5s] expansion: subject rises; camera orbits" />
                </div>
                <div>
                  <label for="beat3">Beat 3</label>
                  <input id="beat3" type="text" placeholder="[5–8s] resolution: leap/hold; lens flare kiss" />
                </div>
              </div>
            </div>
          </details>

          <!-- AUDIO -->
          <details>
            <summary><b>Audio — BGM / SFX / Cues</b></summary>
            <div class="section" style="margin-top:10px">
              <div class="row">
                <div>
                  <label for="bgm">BGM</label>
                  <textarea id="bgm" placeholder="taiko‑pulse + glassy pads + shakuhachi echoes (148 BPM; evolving rises/falls)"></textarea>
                </div>
                <div>
                  <label for="sfx">SFX</label>
                  <textarea id="sfx" placeholder="dew plinks; wind; distant thunder; stone grit; warp whooms"></textarea>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="cues">Cues / Mix notes</label>
                  <textarea id="cues" placeholder="pre‑lap VO; L/J‑cuts; sidechain duck BGM ~3 dB on impacts; key hits [0.6s][3.0s][7.2s]"></textarea>
                </div>
                <div>
                  <label for="dialogue">Dialogue / VO (optional)</label>
                  <textarea id="dialogue" placeholder='[0–1s] "Open the breath; the world answers."'></textarea>
                </div>
              </div>
            </div>
          </details>

          <!-- REFERENCES -->
          <details>
            <summary><b>References</b> <span class="sub">(look, motion, style)</span></summary>
            <div class="section" style="margin-top:10px">
              <div class="row">
                <div>
                  <label for="lookRef">Look reference URL</label>
                  <input id="lookRef" type="url" placeholder="https://… moodboard or still" />
                </div>
                <div>
                  <label for="motionRef">Motion reference URL</label>
                  <input id="motionRef" type="url" placeholder="https://… example clip" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="styleLUT">Style LUT / palette URL (optional)</label>
                  <input id="styleLUT" type="url" placeholder="https://… .cube / palette" />
                </div>
                <div>
                  <label for="engineNotes">Engine notes / constraints</label>
                  <input id="engineNotes" type="text" placeholder="e.g., avoid internal lens calls; no unsupported tags" />
                </div>
              </div>
            </div>
          </details>

          <!-- ASK / EVALUATE / CONSTRAINTS -->
          <details open>
            <summary><b>Ask / Evaluate / Constraints</b></summary>
            <div class="section" style="margin-top:10px">
              <div class="row">
                <div>
                  <label for="ask">Ask — What to generate</label>
                  <textarea id="ask" placeholder="Generate a cinematic video prompt in the structure below. Use concise, production‑ready language."></textarea>
                </div>
                <div>
                  <label for="constraints">Output constraints</label>
                  <textarea id="constraints" placeholder="250–500 words; compact bullets; no extra commentary"></textarea>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="criteria">Evaluate — Criteria & weights</label>
                  <textarea id="criteria" placeholder="Visual coherence(3); Cinematic composition(2); Emotional clarity(2); Creative novelty(1)"></textarea>
                </div>
                <div>
                  <label for="format">Preferred output format</label>
                  <input id="format" type="text" placeholder="Markdown with headings; no extra commentary" />
                </div>
              </div>
            </div>
          </details>
        </div>
      </section>

      <aside class="card" aria-labelledby="pv-title">
        <h2 id="pv-title">Live Prompt Preview</h2>
        <div class="body">
          <div id="lint" class="lint" style="margin-bottom:10px"></div>
          <div id="preview" class="preview" aria-live="polite"></div>
          <div class="meter" style="margin-top:10px">
            <span>Length</span>
            <span class="meter-bar"><i id="meter"></i></span>
            <span id="chars">0 chars</span>
            <span>·</span>
            <span id="tokens">~0 tokens</span>
          </div>
          <div class="sub" style="margin-top:8px">Tips: <span class="kbd">Ctrl/Cmd + K</span> focus search · <span class="kbd">Ctrl/Cmd + S</span> save · <span class="kbd">Ctrl/Cmd + /</span> copy prompt</div>
        </div>
      </aside>
    </div>

    <footer style="margin-top:14px;color:var(--muted);font-size:11px;text-align:center">
      Single‑file app. Autosaves locally per profile. Engine presets adjust lint rules and hints.
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const LS_KEY = 'cinematic-prompt-studio-pro-v1';

    const defaultState = {
      profile: 'Mythic Nature v2', engine:'generic',
      title:'Whispering Silence', handle:'@creator', environment:'Mythic Nature',
      concept:'Lucid‑zen meditation in a primeval dreamscape.', role:'Visionary cinematographer + director crafting composition, motion, and light.',
      tone:'zen‑fantasy / awe‑forward', audience:'{locale="JP"}', narrativeTone:'lucid‑zen / awe‑forward',
      subjectType:'person (meditation guru)', environmentType:'fantastical nature',
      keyFeatures:'seated lotus; breath vapor; bioluminescent pollen; floating stones; rippling air',
      scaleMotion:'Scale: intimate→cosmic; Motion: emergence → expansion → resolution',
      age:'30s', vibe:'calm, enigmatic', skin:'Skin: fair; Makeup: natural; Hair: black, neat',
      outfit:'sand‑ivory kimono + dark hakama + barefoot', accessories:'wooden mala beads',
      location:'moss cathedral valley', timeOfDay:'blue hour→astral night', weatherLight:'cool mist, god rays, light rain sparkle',
      visualTaste:'zen sci‑fantasy / prestige doc', fg:'dew ferns; soft fireflies', mg:'subject on basalt slab', bg:'mythic cedars; obsidian torii; levitating stones',
      lighting:'motivated key; soft; rim/kicker; neg fill; bounce; gobo; haze medium; vol shafts',
      grade:'teal–amber palette; S‑curve contrast; gentle halation; vignette; fine grain; mild CA; clean anamorphic flares',
      persist:'same jacket & mala; floating pollen motif; breath condenses in CU', backgroundDesc:'primeval Japan dreamscape',
      camera:'WS/MS/CU/ECU/Insert; centered→thirds; occluders for parallax; jib/gimbal/orbit/whip/POV',
      lens:'24/35/50/90 feel; split‑diopter macro; creamy bokeh; gentle racks; face priority',
      coverage:'master + tactile inserts; match‑on‑action; strict screen direction; honest eyelines',
      duration:8.0,
      beat1:'[0–2s] emergence: breath opens; particles wake', beat2:'[2–5s] expansion: subject rises; camera orbits', beat3:'[5–8s] resolution: leap/hold; lens flare kiss',
      bgm:'taiko‑pulse + glassy pads + shakuhachi echoes (148 BPM; evolving rises/falls)',
      sfx:'dew plinks; soft wind; distant thunder; stone grit; low warp whooms',
      cues:'pre‑lap VO; L/J‑cuts; sidechain — duck BGM ~3 dB on impacts; key hits [0.6s][3.0s][7.2s]',
      dialogue:'[0–1s] "Open the breath; the world answers."',
      lookRef:'', motionRef:'', styleLUT:'', engineNotes:'avoid unsupported tags; keep camera terms high-level',
      ask:'Generate a cinematic video prompt in the structure below. Use concise, production‑ready language.',
      constraints:'250–500 words; compact bullets; no extra commentary.',
      criteria:'Visual coherence(3); Cinematic composition(2); Emotional clarity(2); Creative novelty(1)',
      format:'Markdown with headings; no extra commentary'
    };

    let state = {...defaultState};

    function save(){ const key = `${LS_KEY}::${state.profile||'default'}`; localStorage.setItem(key, JSON.stringify(state)); }
    function load(profile){ const key = `${LS_KEY}::${profile||'default'}`; const raw = localStorage.getItem(key); if(raw){ state = JSON.parse(raw); } else { state = {...defaultState, profile: profile||defaultState.profile}; } }

    // ---------- Engine lint rules (lightweight/static) ----------
    const ENGINE_RULES = {
      generic:{ forbidden:[], hints:['Keep language simple and explicit.'] },
      runway:{ forbidden:['internal ISO','f‑stop','shutter 1/'], hints:['Avoid specific camera settings (ISO/f‑stop/shutter).','Prefer semantic moves over numeric parameters.'] },
      pika:{ forbidden:['fps 240','Gyro cam'], hints:['Keep FPS ranges broad (e.g., 24–60).','Avoid rare rig names; use generic "gimbal/jib/orbit".'] },
      kling:{ forbidden:['中文以外'], hints:['Stick to English prompts unless model supports multilingual.'] },
      sora:{ forbidden:['lens mm exact'], hints:['Use film grammar (motivated key, rim) rather than precise lens mm.'] }
    };

    function lintPrompt(text){
      const rules = ENGINE_RULES[state.engine]||ENGINE_RULES.generic;
      const hits = [];
      rules.forbidden.forEach(term=>{ if(text.toLowerCase().includes(term.toLowerCase())) hits.push(`Forbidden term for preset: "${term}"`); });
      return {hits, hints:rules.hints||[]};
    }

    // ---------- Assembler ----------
    function line(s){ return (s||'').toString().trim(); }
    function section(label, body){ return body?`## ${label}\n${body}`:''; }

    function assemble(){
      const header = `# ${line(state.title)}${state.handle?` — ${line(state.handle)}`:''} in ${line(state.environment)}`;

      const subject = [
        `- Audience: ${line(state.audience)}; Narrative tone: ${line(state.narrativeTone)}`,
        `- Subject type: ${line(state.subjectType)}; environment: ${line(state.environmentType)}`,
        `- Key features: ${line(state.keyFeatures)}`,
        `${line(state.scaleMotion)}`,
        `- Age: ${line(state.age)}; Vibe: ${line(state.vibe)}; ${line(state.skin)}`,
        `- Outfit: ${line(state.outfit)}; accessories: ${line(state.accessories)}`,
        `- Location: ${line(state.location)}; Time: ${line(state.timeOfDay)}; Weather/Light: ${line(state.weatherLight)}`,
        `- Key elements (FG/MG/BG): FG ${line(state.fg)}; MG ${line(state.mg)}; BG ${line(state.bg)}`,
        `- Lighting: ${line(state.lighting)}`,
        `- Grade: ${line(state.grade)}`,
        `- Visual taste: ${line(state.visualTaste)}; Background/Location: ${line(state.backgroundDesc)}`,
        `- Camera: ${line(state.camera)}`,
        `- Lens/Focus: ${line(state.lens)}`,
        `- Coverage: ${line(state.coverage)}`,
        `- Duration: ${line(state.duration)}s`,
        `- Persist: ${line(state.persist)}`
      ].join('\n');

      const beats = [state.beat1, state.beat2, state.beat3].filter(Boolean).join('\n');

      const audio = [
        `- BGM: ${line(state.bgm)}`,
        `- SFX: ${line(state.sfx)}`,
        `- Cues: ${line(state.cues)}`
      ].join('\n');

      const refs = [
        state.lookRef?`- Visual reference: ${line(state.lookRef)}`:'',
        state.motionRef?`- Motion reference: ${line(state.motionRef)}`:'',
        state.styleLUT?`- Style LUT / palette: ${line(state.styleLUT)}`:'',
        state.engineNotes?`- Engine notes: ${line(state.engineNotes)}`:''
      ].filter(Boolean).join('\n');

      const meta = [
        `**Ask**\n${line(state.ask)}`,
        `**Tone**\n- ${line(state.tone)}`,
        `**Evaluate**\n- ${line(state.criteria).replace(/;\s*/g,'\n- ')}`,
        state.constraints?`**Constraints**\n- ${line(state.constraints)}`:'',
        state.format?`**Preferred Output Format**\n- ${line(state.format)}`:''
      ].filter(Boolean).join('\n\n');

      const dialogBlock = state.dialogue?.trim()?`\n\n## Dialogues / Subtitles / VO (optional)\n${state.dialogue.trim()}`:'';

      const text = [
        header,
        section('Subject / Scene Settings', subject),
        section('Motion Arc (timecoded beats)', beats),
        section('Audio (BGM & SFX)', audio),
        section('References', refs),
        dialogBlock,
        '\n\n---\n\n'+meta
      ].join('\n\n');

      return text.trim();
    }

    // ---------- Bind UI ----------
    const ids = ['profile','engine','title','handle','environment','concept','role','tone','audience','narrativeTone','subjectType','environmentType','keyFeatures','scaleMotion','age','vibe','skin','outfit','accessories','location','timeOfDay','weatherLight','visualTaste','fg','mg','bg','lighting','grade','persist','backgroundDesc','camera','lens','coverage','duration','beat1','beat2','beat3','bgm','sfx','cues','dialogue','lookRef','motionRef','styleLUT','engineNotes','ask','constraints','criteria','format'];

    function render(){
      // push state into inputs
      ids.forEach(id=>{ const el = document.getElementById(id); if(!el) return; if(el.tagName==='SELECT'){ el.value = state[id]||el.value; } else { el.value = (state[id] ?? ''); } });
      // preview
      const text = assemble();
      const chars = text.length; const tokens = Math.max(1, Math.round(chars/4));
      $('#preview').textContent = text;
      $('#chars').textContent = `${chars.toLocaleString()} chars`;
      $('#tokens').textContent = `~${tokens.toLocaleString()} tokens`;
      $('#meter').style.width = `${Math.min(100, Math.round((chars/3200)*100))}%`;
      // lint
      const {hits,hints} = lintPrompt(text);
      $('#lint').innerHTML = [
        hits.length?`<div><b>Lint:</b> ${hits.map(h=>`• ${h}`).join(' &nbsp; ')}</div>`:'',
        hints.length?`<div style="opacity:.85">Hints: ${hints.join(' · ')}</div>`:''
      ].filter(Boolean).join('');
    }

    function bind(){
      ids.forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        const handler = (e)=>{ state[id] = (el.type==='number')? Number(e.target.value||0): e.target.value; save(); render(); };
        el.addEventListener('input', handler); el.addEventListener('change', handler);
      });
      $('#btnCopy').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(assemble()); flash('Copied to clipboard'); }catch{ fallbackCopy(assemble()); flash('Copied (fallback)'); } });
      $('#btnDownload').addEventListener('click', ()=>{ const blob = new Blob([assemble()],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`${(state.title||'CINEMATIC')}_prompt.txt`; a.click(); URL.revokeObjectURL(url); });
      $('#btnExport').addEventListener('click', ()=>{ const json = JSON.stringify(state,null,2); const blob = new Blob([json],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${(state.profile||'worksheet')}.json`; a.click(); URL.revokeObjectURL(url); });
      $('#fileImport').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(String(r.result)); state={...state,...obj}; save(); render(); flash('Worksheet imported'); }catch{ alert('Invalid JSON'); } }; r.readAsText(f); });
      $('#btnNew').addEventListener('click', ()=>{ if(confirm('Start a new profile?')){ state={...defaultState, profile:`Profile ${new Date().toLocaleString()}`}; save(); render(); }});
      // keyboard shortcuts
      window.addEventListener('keydown', (e)=>{
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); save(); flash('Saved'); }
        if((e.ctrlKey||e.metaKey) && e.key==='/'){ e.preventDefault(); navigator.clipboard.writeText(assemble()).then(()=>flash('Copied to clipboard')); }
      });
    }

    function flash(msg){ const n=document.createElement('div'); n.textContent=msg; Object.assign(n.style,{position:'fixed',right:'16px',bottom:'16px',padding:'10px 14px',background:'rgba(34,211,238,.15)',border:'1px solid rgba(34,211,238,.45)',color:'#e0f2fe',borderRadius:'12px',boxShadow:'var(--shadow-md)',zIndex:9999}); document.body.appendChild(n); setTimeout(()=>n.remove(),1600); }
    function fallbackCopy(text){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }

    // init
    (function(){ load(defaultState.profile); bind(); render(); })();
  </script>
</body>
</html>
